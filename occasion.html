<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Member Anniversary</title>
  <meta name="robots" content="noindex, nofollow"> <!-- Page not to be part of Google Search -->
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Favicons -->
  <link href="assets/img/MOV-logo.png" rel="icon">
  <link href="assets/img/MOV-logo.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Inter:wght@100;200;300;400;500;600;700;800;900&family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: QuickStart with Bootstrap v5.3.3
  ======================================================== -->
</head>

<body class="service-details-page">

  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">

      <a href="#" class="logo d-flex align-items-center me-auto">
        <img src="assets/img/MOV-logo.png" alt="">
        <h1 class="sitename">Members</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="dashboard.html">Home</a></li>
          <li><a href="directory.html">Family Directory</a></li>
          <li><a href="#" class="active">Annual Occasions</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>

      <a class="btn-getstarted" onclick="logout()" href="#">Logout</a>

    </div>
  </header>

  <main class="main">
    <!-- Page Title -->
    <div class="page-title" data-aos="fade">
        <div class="container d-lg-flex justify-content-between align-items-center">
          <h1 class="mb-2 mb-lg-0">Celebrations</h1>
          <nav class="breadcrumbs">
            <ol>
              <li>Current</li>
              <li>Month</li>
            </ol>
          </nav>
        </div>
     </div><!-- End Page Title -->

      <!-- Service Details Section -->
      <section id="service-details" class="service-details section">
  
        <div class="container">
            <!-- Dropdown to select section -->
            <div class="row gy-5">
                <div class="col-lg-4">
                    <label for="data-selector">Occasion:</label>
                    <select id="data-selector" class="form-select" onchange="changeTableData()">
                        <option value="birthday" selected>Birthday</option>
                        <option value="anniversary">Wedding Anniversary</option>
                    </select>
                </div>
            </div>
            <p></p>
               <!-- Loading Spinner -->
            <div id="loadingMessage" class="text-center" style="display:block;">
              <!-- Bootstrap spinner -->
              <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
              </div>
              <p id="loadingText">Please hang on while we load the data...</p>
            </div>
            <!-- Occasion Table -->
            <table id="occasion-table" class="table table-bordered">
                <thead>
                    <tr>
                        <th>Member Name</th>
                        <th>Month-Day</th>
                        <th>Unit Name</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Birthday table rows will be filled dynamically -->
                </tbody>
            </table>

        </div>

      </section><!-- /Service Details Section -->

  </main>

  <footer id="footer" class="footer position-relative light-background">

    <div class="container copyright text-center mt-4">
      <strong class="px-1 sitename">Mother Of Victory Shrine</strong><p>Tikujiniwadi, Thane</p>
      <div class="credits">
        Developed with <i class="bi bi-heart-fill" style="color: red;"></i> by <strong><a href="https://getitautomated.com" target="_blank" rel="noopener noreferrer">Tom Thomas</a></strong>
      </div>
    </div>

  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>
  
  <!-- Firebase SDKs from CDN (browser version) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

  <script>
      
      let birthdayList = [];
      let anniversaryList = [];

      // Function to show the loading spinner
    function showLoading() {
        //console.log('Showing loading spinner...');
        document.getElementById('loadingMessage').style.display = 'block'; // Show the spinner
    }

    // Function to hide the loading spinner
    function hideLoading() {
      //console.log('Hiding loading spinner...');  
      document.getElementById('loadingMessage').style.display = 'none'; // Hide the spinner
    }

      const firebaseConfig = {
        apiKey: "AIzaSyCOboG8dsoh6MSW3lL_9pY9pB1kUJ35e7U",
        authDomain: "movchurch-400610.firebaseapp.com",
        projectId: "movchurch-400610",
        appId: "1:1088970662172:web:c57adb76c641b1a3749ad9"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      auth.onAuthStateChanged(async function(user) {
        if (!user) {
          window.location.href = 'index.html';
          return;
        }

        try {
          const idToken = await user.getIdToken();

          // Check for cached data
          const cachedBirthdays = sessionStorage.getItem('birthdayList');
          const cachedAnniversaries = sessionStorage.getItem('anniversaryList');

          if (cachedBirthdays && cachedAnniversaries) {
            birthdayList = JSON.parse(cachedBirthdays);
            anniversaryList = JSON.parse(cachedAnniversaries);
            const selectedValue = document.getElementById('data-selector').value;
            fillDataTable(selectedValue);
            // Hide spinner
            document.getElementById('loadingMessage').style.display = 'none';

          } else {
            fetchOccasionData(idToken);
          }
        } catch (err) {
          console.error("Token error:", err);
          alert("Unable to verify user. Please try logging in again.");
          auth.signOut();
        }
      });

      async function fetchOccasionData(idToken) {
        try {
          // Show loading spinner
          document.getElementById('loadingMessage').style.display = 'block';
          
          const url = `https://script.google.com/macros/s/AKfycbxwcm-GuZRZckXiiZJQUTcGWjJGYTFOdLR3QzleM1hqzvYJU2IE91gj7YIHjDhXxCBX/exec?idToken=${idToken}&section=celeb`;
          const response = await fetch(url);
          const data = await response.json();

          // Validate and process data
          if (Array.isArray(data.birthdays)) {
            birthdayList = data.birthdays;
            sessionStorage.setItem('birthdayList', JSON.stringify(birthdayList));
          }

          if (Array.isArray(data.anniversaries)) {
            anniversaryList = data.anniversaries;
            sessionStorage.setItem('anniversaryList', JSON.stringify(anniversaryList));
          }

          const selectedValue = document.getElementById('data-selector').value;
          fillDataTable(selectedValue);
        } catch (err) {
          console.error('Fetch error:', err);
          alert("Unable to fetch occasion data. Please try again later.");
        } finally {
          // Hide loading spinner regardless of success or error
          document.getElementById('loadingMessage').style.display = 'none';
        }
      }

      function fillDataTable(occasion) {
        const tableBody = document.getElementById('occasion-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';

        const data = occasion === 'birthday' ? birthdayList : anniversaryList;
        if (data.length === 0) {
          const tr = tableBody.insertRow();
          tr.innerHTML = `<td colspan="3" class="text-center">No records found</td>`;
        }
        else{
            data.forEach(row => {
            const tr = tableBody.insertRow();
            tr.innerHTML = `<td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td>`;
          });
        }
        
        document.getElementById('occasion-table').style.display = 'table';
      }

      function changeTableData() {
        const selectedValue = document.getElementById('data-selector').value;
        fillDataTable(selectedValue);
      }

      function logout() {
        auth.signOut().then(() => {
          sessionStorage.removeItem('birthdayList');
          sessionStorage.removeItem('anniversaryList');
          window.location.href = 'index.html';
        }).catch(error => {
          console.error('Logout error:', error);
        });
      }
  </script>

</body>

</html>